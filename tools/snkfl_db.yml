coloc_tsv_gz = config['coloc_tsv_gz']
etissue_cat_ods = config['etissue_cat_ods']
gwas_cat_ods = config['gwas_cat_ods']
outdir = config['outdir']
url_db = config['url_db']
upper_var_gwas_cat_count = config['upper_var_gwas_cat_count']

"""time snakemake --cores 1 -p -s tools/snkfl_db.yml --config url_db='sqlite:///out/gwas420/pval_5e-08/r2_0.1/kb_1000/window_1000000/db/db.sqlite' coloc_tsv_gz=../gwas2eqtl/out/gwas420/gwas_ebi-a-GCST002318_eqtl_Schmiedel_2018_CD8_T-cell_naive.tsv.gz outdir=out/gwas420/pval_5e-08/r2_0.1/kb_1000/window_1000000 gwas_cat_ods=config/gwas420.ods etissue_cat_ods=config/etissue_category.ods --rerun-incomplete"""

rule all:
    input:
        os.path.join(outdir, "cmpt_count_per_rsid.py/count_per_rsid_gwas.tsv"),

rule count_per_rsid:
    input:
        os.path.join(outdir, "filter_h4_2.py/h4.tsv"),
    output:
        os.path.join(outdir, "cmpt_count_per_rsid.py/count_per_rsid_gwas.tsv"),
        os.path.join(outdir, "cmpt_count_per_rsid.py/count_per_rsid_egene.tsv"),
        os.path.join(outdir, "cmpt_count_per_rsid.py/count_per_rsid_etissue.tsv"),
        os.path.join(outdir, "cmpt_count_per_rsid.py/variant_pleio_1_flank_0_hg38.bed"),
        os.path.join(outdir, "cmpt_count_per_rsid.py/variant_pleio_1_flank_50_hg38.bed"),
        os.path.join(outdir, "cmpt_count_per_rsid.py/count_per_rsid_gwas_egene_etissue.tsv"),
    params:
        upper_var_gwas_cat_count=upper_var_gwas_cat_count
    shell:
        "python scripts/cmpt_count_per_rsid.py {input[0]} {params.upper_var_gwas_cat_count} {output[0]}"

rule filter_h4:
    input:
        etissue_cat_ods,
        os.path.join(outdir, "db/db_annotated.txt"),
    output:
        os.path.join(outdir, "filter_h4_2.py/h4.tsv"),
    params:
        url_db,
    shell:
        "python scripts2/filter_h4_2.py {params[0]} {input[0]} {output[0]}"

rule annotate:
    input:
        os.path.join(outdir, "db/db_imported.txt"),
        gwas_cat_ods,
        etissue_cat_ods,
    output:
        os.path.join(outdir, "db/db_annotated.txt"),
    params:
        url_db,
    shell:
        """python scripts2/annotate2.py {params[0]} {input[1]} {input[2]} {output[0]}
        touch {output[0]}"""

rule import:
    input:
        coloc_tsv_gz,
    output:
        os.path.join(outdir, "db/db_imported.txt"),
    params:
        url_db.replace('sqlite:///', ''),
    shell:
        """
        rm -f {params[0]}
        
        gunzip -c {input[0]} |sqlite3 -csv -separator $'\t' {params[0]} '.import --skip 0 /dev/stdin colocimport'

        touch {output[0]}
        """


"""
        
        sqlite3 {params[0]} 'create table coloc (id INTEGER PRIMARY KEY AUTOINCREMENT, chrom INTEGER NOT NULL, pos INTEGER NOT NULL, rsid TEXT NOT NULL, ref TEXT NOT NULL, alt TEXT NOT NULL, egene TEXT NOT NULL, gwas_beta REAL NOT NULL, gwas_pval REAL NOT NULL, gwas_id TEXT NOT NULL, eqtl_beta REAL NOT NULL, eqtl_pval REAL NOT NULL, eqtl_id TEXT NOT NULL, "PP.H4.abf" REAL NOT NULL, nsnps INTEGER NOT NULL, "SNP.PP.H4" REAL NOT NULL, "PP.H3.abf" REAL NOT NULL, "PP.H2.abf" REAL NOT NULL, "PP.H1.abf" REAL NOT NULL, "PP.H0.abf" REAL NOT NULL, coloc_lead_pos INTEGER NOT NULL, coloc_lead_rsid TEXT NOT NULL, coloc_region TEXT NOT NULL);'
        sqlite3 {params[0]} 'INSERT INTO coloc("chrom", "pos", "rsid", "ref", "alt", "egene", "gwas_beta", "gwas_pval", "gwas_id", "eqtl_beta", "eqtl_pval", "eqtl_id", "PP.H4.abf", "SNP.PP.H4", "nsnps", "PP.H3.abf", "PP.H2.abf", "PP.H1.abf", "PP.H0.abf", "coloc_lead_pos", "coloc_lead_rsid", "coloc_region") SELECT * FROM coloctemp;'
        sqlite3 {params[0]} 'DROP TABLE coloctemp;'"""